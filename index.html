<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S23 Ultra AI Race - Prototip</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #00ff00; font-family: 'Courier New', monospace; }
        #video-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.3; }
        canvas { position: absolute; width: 100%; height: 100%; transform: scaleX(-1); }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        #wheel-visual { 
            position: absolute; bottom: 10%; width: 150px; height: 150px; 
            border: 8px dashed #00ff00; border-radius: 50%; transition: transform 0.1s;
        }
        .status { color: white; background: rgba(0,255,0,0.2); padding: 5px 10px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="status">Cihaz: S23 Ultra Optimized</div>
        <div class="status">AÃ§Ä±: <span id="angleText">0</span>Â°</div>
        <div class="status">Durum: <span id="statusText">YÃ¼kleniyor...</span></div>
    </div>

    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
        <div id="wheel-visual"></div>
    </div>

    <script type="module">
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        const angleText = document.getElementById("angleText");
        const statusText = document.getElementById("statusText");
        const wheelVisual = document.getElementById("wheel-visual");

        let handLandmarker = undefined;
        let lastVideoTime = -1;

        // 1. MediaPipe Modelini YÃ¼kle
        async function setupAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU" // S23 Ultra GPU'sunu ateÅŸle
                },
                runningMode: "VIDEO",
                numHands: 2
            });
            statusText.innerText = "Kamera AÃ§Ä±lÄ±yor...";
            startKamera();
        }

        // 2. KamerayÄ± BaÅŸlat
        function startKamera() {
            navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } }).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                statusText.innerText = "Sistem HazÄ±r! Elleri KaldÄ±r ðŸ™Œ";
            });
        }

        // 3. Tahmin DÃ¶ngÃ¼sÃ¼
        async function predictWebcam() {
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, performance.now());

                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

                if (results.landmarks && results.landmarks.length === 2) {
                    // Ä°ki elin bilek noktalarÄ±nÄ± (Landmark 0) al
                    const h1 = results.landmarks[0][0];
                    const h2 = results.landmarks[1][0];

                    // AÃ§Ä± hesapla
                    let deg = Math.atan2(h2.y - h1.y, h2.x - h1.x) * (180 / Math.PI);
                    
                    // Normalize et (Kamera ters olduÄŸu iÃ§in dengele)
                    if (deg > 90) deg -= 180;
                    if (deg < -90) deg += 180;
                    deg = -deg; // Ters yÃ¶ne kÄ±rmasÄ±n

                    angleText.innerText = Math.round(deg);
                    wheelVisual.style.transform = `rotate(${deg}deg)`;

                    // Ekrana iki el arasÄ±na Ã§izgi Ã§iz
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(h1.x * canvasElement.width, h1.y * canvasElement.height);
                    canvasCtx.lineTo(h2.x * canvasElement.width, h2.y * canvasElement.height);
                    canvasCtx.strokeStyle = "#00ff00";
                    canvasCtx.lineWidth = 10;
                    canvasCtx.stroke();
                }
            }
            window.requestAnimationFrame(predictWebcam);
        }

        setupAI();
    </script>
</body>
</html>