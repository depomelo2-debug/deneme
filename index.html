<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Racer - Gas & Steering Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
        #webcam { display: none; }
        
        /* Gelişmiş HUD */
        #hud-container {
            position: absolute; top: 20px; right: 20px;
            width: 120px; height: 120px;
            border: 2px solid #0f0; border-radius: 50%;
            background: rgba(0, 255, 0, 0.05); z-index: 100;
        }
        #horizon-dot {
            position: absolute; top: 50%; left: 50%;
            width: 14px; height: 14px; background: #0f0;
            border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #0f0; transition: top 0.1s, left 0.1s;
        }
        /* Hız Göstergesi (Dikey Bar) */
        #speed-bar-container {
            position: absolute; top: 20px; right: 150px;
            width: 10px; height: 120px; border: 1px solid #0f0; background: rgba(0,0,0,0.5);
        }
        #speed-bar-fill {
            position: absolute; bottom: 0; width: 100%;
            height: 0%; background: #0f0; box-shadow: 0 0 10px #0f0;
        }

        #ui { position: absolute; top: 20px; left: 20px; color: #0f0; z-index: 100; font-family: monospace; font-size: 18px; line-height: 1.5; }
        #fs-button {
            position: absolute; bottom: 20px; left: 20px; z-index: 200;
            padding: 15px 30px; background: #0f0; color: #000; border: none; font-weight: bold; border-radius: 8px;
        }
    </style>
</head>
<body>

    <div id="ui">SKOR: <span id="score">0</span><br>HIZ: <span id="kmh">0</span> KM/H</div>
    <div id="speed-bar-container"><div id="speed-bar-fill"></div></div>
    <div id="hud-container"><div id="horizon-dot"></div></div>
    
    <button id="fs-button">TAM EKRAN & YARIŞA BAŞLA</button>
    <video id="webcam" autoplay playsinline></video>
    <div id="game-container"></div>

    <script type="module">
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById("webcam");
        const dot = document.getElementById("horizon-dot");
        const speedFill = document.getElementById("speed-bar-fill");
        const kmhElement = document.getElementById("kmh");
        const fsButton = document.getElementById("fs-button");

        let handLandmarker;
        let lastVideoTime = -1;
        let steeringAngle = 0;
        let handHeight = 0.5; // 0 (üst) ile 1 (alt) arası
        let score = 0;
        let gameActive = true;

        fsButton.addEventListener('click', () => {
            document.documentElement.requestFullscreen();
            fsButton.style.display = 'none';
        });

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH },
            physics: { default: 'arcade' },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let player, roadLines, enemies;
        let currentSpeed = 10;
        let baseSpeed = 8;

        function preload() {
            this.load.image('playerCar', 'car.png');
            // Düşmanlar için kareler
            const graphics = this.make.graphics({ x: 0, y: 0, add: false });
            graphics.fillStyle(0xffffff, 1);
            graphics.fillRect(0, 0, 50, 85);
            graphics.generateTexture('enemyCar', 50, 85);
        }

        function create() {
            gameActive = true;
            this.add.rectangle(this.cameras.main.width/2, this.cameras.main.height/2, this.cameras.main.width * 0.6, this.cameras.main.height, 0x111111);
            
            roadLines = this.add.group();
            for(let i=0; i<15; i++) {
                roadLines.add(this.add.rectangle(this.cameras.main.width/2, i * 100, 8, 60, 0x333333));
            }

            player = this.physics.add.sprite(this.cameras.main.width/2, this.cameras.main.height - 120, 'playerCar');
            player.setScale(0.4); 
            player.setCollideWorldBounds(true);
            enemies = this.physics.add.group();

            this.time.addEvent({
                delay: 800,
                callback: () => {
                    if(!gameActive) return;
                    let range = this.cameras.main.width * 0.26;
                    let x = Phaser.Math.Between(this.cameras.main.width/2 - range, this.cameras.main.width/2 + range);
                    let enemy = enemies.create(x, -100, 'enemyCar');
                    enemy.setTint(Phaser.Utils.Array.GetRandom([0xff0000, 0xffff00, 0x00ff00, 0x0000ff]));
                },
                loop: true
            });

            this.physics.add.overlap(player, enemies, () => {
                gameActive = false;
                this.cameras.main.shake(300, 0.04);
                if (navigator.vibrate) navigator.vibrate(200); // S23 Ultra Titreşim!
                this.time.delayedCall(1500, () => { this.scene.restart(); score = 0; currentSpeed = 10; });
            });
        }

        function update() {
            if(!gameActive) return;

            // HIZ HESAPLAMA: Eller yukarıdaysa (handHeight küçükse) hız artar
            // handHeight 0 (tepe) -> Hız çarpanı 2.5x
            // handHeight 1 (alt) -> Hız çarpanı 0.5x
            let speedMultiplier = Phaser.Math.Linear(2.5, 0.5, handHeight);
            currentSpeed = baseSpeed * speedMultiplier;

            // Yol ve düşman akışı hıza göre değişir
            roadLines.getChildren().forEach(line => {
                line.y += currentSpeed;
                if (line.y > this.cameras.main.height) line.y = -60;
                line.x = this.cameras.main.width/2;
            });

            enemies.getChildren().forEach(enemy => {
                enemy.y += currentSpeed + 2;
                if (enemy.y > this.cameras.main.height + 100) enemy.destroy();
            });

            // Direksiyon
            let targetX = (this.cameras.main.width / 2) + (steeringAngle * 18);
            player.x = Phaser.Math.Linear(player.x, targetX, 0.15);
            let limit = this.cameras.main.width * 0.28;
            player.x = Phaser.Math.Clamp(player.x, this.cameras.main.width/2 - limit, this.cameras.main.width/2 + limit);
            player.angle = steeringAngle * 0.4;

            // HUD Güncelleme
            let dotX = 50 + (steeringAngle * 1.5); 
            let dotY = 50 + ((handHeight - 0.5) * 100); 
            dot.style.left = `${Phaser.Math.Clamp(dotX, 10, 90)}%`;
            dot.style.top = `${Phaser.Math.Clamp(dotY, 10, 90)}%`;
            
            let speedPercent = Phaser.Math.Linear(100, 0, handHeight);
            speedFill.style.height = `${speedPercent}%`;
            
            kmhElement.innerText = Math.floor(currentSpeed * 15);
            score += Math.floor(currentSpeed / 5);
            document.getElementById("score").innerText = Math.floor(score / 10);
        }

        async function initAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 2
            });
            startKamera();
        }

        function startKamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
                video.srcObject = s;
                video.addEventListener("loadeddata", predict);
            });
        }

        async function predict() {
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const result = handLandmarker.detectForVideo(video, performance.now());

                if (result.landmarks && result.landmarks.length === 2) {
                    const h1 = result.landmarks[0][0];
                    const h2 = result.landmarks[1][0];
                    
                    // AÇI (Direksiyon)
                    let deg = Math.atan2(h2.y - h1.y, h2.x - h1.x) * (180 / Math.PI);
                    if (deg > 90) deg -= 180;
                    if (deg < -90) deg += 180;
                    steeringAngle = -deg * 2;

                    // YÜKSEKLİK (Gaz)
                    // İki elin y koordinatının ortalamasını alıyoruz (0 tepe, 1 alt)
                    handHeight = (h1.y + h2.y) / 2;
                } else {
                    steeringAngle *= 0.9;
                    handHeight = 0.8; // Eller yoksa yavaşla
                }
            }
            requestAnimationFrame(predict);
        }

        initAI();
    </script>
</body>
</html>