<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S23 Ultra - Hybrid AI Racer</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        #webcam { display: none; }
        
        /* Giriş Seçim Ekranı */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 500; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #fff;
        }
        .title { font-size: 32px; color: #ff0055; margin-bottom: 40px; text-shadow: 3px 3px #fff; }
        .menu-btn {
            width: 280px; padding: 15px; margin: 10px; border: 2px solid #fff;
            background: transparent; color: #fff; font-size: 18px; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; font-weight: bold;
        }
        .menu-btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }
        .menu-btn.ai { border-color: #00ff88; color: #00ff88; }
        .menu-btn.ai:hover { background: #00ff88; color: #000; }

        /* HUD & UI Elements */
        #hud-container {
            position: absolute; top: 25px; right: 25px; width: 90px; height: 90px;
            border: 3px solid #ff0055; border-radius: 50%; z-index: 200; display: none;
        }
        #horizon-dot {
            position: absolute; top: 50%; left: 50%; width: 12px; height: 12px;
            background: #fff; border-radius: 50%; transform: translate(-50%, -50%);
        }
        #ui-overlay { position: absolute; top: 20px; left: 140px; color: #fff; z-index: 200; display: none; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="title">SELECT CONTROL MODE</div>
        <button class="menu-btn ai" onclick="startGame('camera')">1. AI CAMERA (Hands)</button>
        <button class="menu-btn" onclick="startGame('gyro')">2. GYROSCOPE (Phone Tilt)</button>
        <button class="menu-btn" onclick="startGame('keyboard')">3. KEYBOARD (Arrows)</button>
        <p style="color: #666; margin-top: 20px; font-size: 12px;">S23 Ultra & PC Optimized</p>
    </div>

    <div id="ui-overlay">
        <div style="color: #ffff00; font-size: 14px;">KM/H</div>
        <div style="font-size: 24px; font-weight: bold;" id="kmh">0</div>
    </div>

    <div id="hud-container"><div id="horizon-dot"></div></div>
    <video id="webcam" autoplay playsinline></video>
    <div id="game-container"></div>

    <script type="module">
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        // Global Değişkenler
        window.controlMode = null;
        let handLandmarker;
        let steeringInput = 0; // -1 (sol) ile 1 (sağ) arası
        let throttleInput = 0.5; // 0 (hızlı) ile 1 (yavaş) arası
        
        const video = document.getElementById("webcam");
        const dot = document.getElementById("horizon-dot");
        const hud = document.getElementById("hud-container");

        // --- OYUNU BAŞLATMA ---
        window.startGame = async function(mode) {
            window.controlMode = mode;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-overlay').style.display = 'block';
            
            if (mode === 'camera') {
                hud.style.display = 'block';
                await initAI();
            } else if (mode === 'gyro') {
                initGyro();
            }
            
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        };

        // --- MODLARI KURMA ---
        async function initAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO", numHands: 2
            });
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
                video.srcObject = s;
                video.addEventListener("loadeddata", predictCamera);
            });
        }

        function initGyro() {
            window.addEventListener('deviceorientation', (event) => {
                // S23 Ultra yatay tutulduğunda gamma değeri direksiyon olur
                let tilt = event.gamma; // -90 to 90
                steeringInput = Phaser.Math.Clamp(tilt / 30, -1, 1);
            });
        }

        // --- PHASER OYUN ---
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let player, roadLines, cursors, smoothSteer = 0;

        function preload() {
            this.load.image('playerCar', 'car.png');
        }

        function create() {
            const w = this.cameras.main.width;
            const h = this.cameras.main.height;
            
            // Yol tasarımı
            this.add.rectangle(w/2, h/2, w * 0.5, h, 0x222222);
            roadLines = this.add.group();
            for(let i=0; i<15; i++) {
                roadLines.add(this.add.rectangle(w/2, i * 100, 8, 50, 0x444444));
            }

            player = this.add.sprite(w/2, h - 150, 'playerCar').setScale(0.5);
            cursors = this.input.keyboard.createCursorKeys();
        }

        function update() {
            if (!window.controlMode) return;

            // 1. INPUTLARI İŞLE
            if (window.controlMode === 'keyboard') {
                if (cursors.left.isDown) steeringInput = -1;
                else if (cursors.right.isDown) steeringInput = 1;
                else steeringInput = 0;
                
                if (cursors.up.isDown) throttleInput = 0;
                else throttleInput = 0.8;
            }

            // 2. FİZİK & HAREKET
            smoothSteer = Phaser.Math.Linear(smoothSteer, steeringInput, 0.1);
            let speed = Phaser.Math.Linear(35, 5, throttleInput);

            roadLines.getChildren().forEach(line => {
                line.y += speed;
                if (line.y > this.cameras.main.height) line.y = -100;
            });

            player.x = (this.cameras.main.width/2) + (smoothSteer * (this.cameras.main.width * 0.22));
            player.angle = smoothSteer * 15;

            // HUD GÜNCELLE
            dot.style.left = `${50 + (smoothSteer * 40)}%`;
            document.getElementById("kmh").innerText = Math.floor(speed * 9);
        }

        async function predictCamera() {
            if (video.currentTime !== lastVideoTime) {
                const res = handLandmarker.detectForVideo(video, performance.now());
                if (res.landmarks && res.landmarks.length === 2) {
                    let h1 = res.landmarks[0][0], h2 = res.landmarks[1][0];
                    let deg = Math.atan2(h2.y - h1.y, h2.x - h1.x) * (180 / Math.PI);
                    if (deg > 90) deg -= 180; if (deg < -90) deg += 180;
                    steeringInput = Phaser.Math.Clamp(-deg / 20, -1, 1);
                    throttleInput = (h1.y + h2.y) / 2;
                }
            }
            requestAnimationFrame(predictCamera);
        }
    </script>
</body>
</html>