<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S23 Ultra - Smooth AI Racer</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; }
        #webcam { display: none; }
        #hud-container {
            position: absolute; top: 20px; right: 20px;
            width: 100px; height: 100px;
            border: 3px solid #0f0; border-radius: 50%;
            background: rgba(0, 0, 0, 0.5); z-index: 100;
        }
        #horizon-dot {
            position: absolute; top: 50%; left: 50%;
            width: 12px; height: 12px; background: #0f0;
            border-radius: 50%; transform: translate(-50%, -50%);
        }
        #ui-side {
            position: absolute; top: 20px; left: 140px; 
            color: #fff; z-index: 100; font-family: monospace;
        }
        #fs-button {
            position: absolute; bottom: 30px; left: 30px; z-index: 200;
            padding: 15px 30px; background: #fff; color: #000; border: none; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="ui-side">1P SCORE: <span id="score">000000</span><br><br><span id="kmh">0</span> km/h</div>
    <div id="hud-container"><div id="horizon-dot"></div></div>
    <button id="fs-button">YARIŞI BAŞLAT</button>
    <video id="webcam" autoplay playsinline></video>
    <div id="game-container"></div>

    <script type="module">
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById("webcam");
        const dot = document.getElementById("horizon-dot");
        const hud = document.getElementById("hud-container");
        const fsButton = document.getElementById("fs-button");

        let handLandmarker;
        let lastVideoTime = -1;
        
        // FİLTRELEME DEĞİŞKENLERİ
        let rawSteeringAngle = 0;
        let smoothSteeringAngle = 0;
        let lerpFactor = 0.08; // NE KADAR KÜÇÜKSE O KADAR YAĞ GİBİ AKAR (0.05 - 0.1 arası ideal)
        
        let handHeight = 0.5;
        let isTracking = false;

        fsButton.addEventListener('click', () => {
            document.documentElement.requestFullscreen();
            fsButton.style.display = 'none';
        });

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            physics: { default: 'arcade' },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let player, roadGroup, decorGroup;
        let currentSpeed = 0;

        function preload() {
            this.load.image('playerCar', 'car.png');
        }

        function create() {
            const w = this.cameras.main.width;
            const h = this.cameras.main.height;

            // Retro Katmanlar
            this.add.rectangle(60, h/2, 120, h, 0x888888); 
            const roadWidth = w * 0.55;
            this.add.rectangle(w/2, h/2, roadWidth + 20, h, 0xffffff); 
            this.add.rectangle(w/2, h/2, roadWidth, h, 0x333333); 
            
            this.add.rectangle(w/2 - roadWidth/2 - 100, h/2, 200, h, 0x008800);
            this.add.rectangle(w/2 + roadWidth/2 + 100, h/2, 200, h, 0x008800);

            roadGroup = this.add.group();
            decorGroup = this.add.group();

            for(let i=0; i<12; i++) {
                roadGroup.add(this.add.rectangle(w/2, i * 120, 10, 50, 0xffffff));
                decorGroup.add(this.add.circle(w/2 - roadWidth/2 - 60, i * 180, 25, 0x004400));
                decorGroup.add(this.add.circle(w/2 + roadWidth/2 + 60, i * 180, 25, 0x004400));
            }

            player = this.physics.add.sprite(w/2, h - 150, 'playerCar').setScale(0.5).setDepth(100);
        }

        function update() {
            const w = this.cameras.main.width;
            const h = this.cameras.main.height;

            // HIZ MANTIĞI
            let targetSpeed = Phaser.Math.Linear(30, 2, handHeight);
            currentSpeed = Phaser.Math.Linear(currentSpeed, targetSpeed, 0.05);

            roadGroup.getChildren().forEach(line => {
                line.y += currentSpeed;
                if (line.y > h) line.y = -100;
            });

            decorGroup.getChildren().forEach(obj => {
                obj.y += currentSpeed;
                if (obj.y > h) obj.y = -100;
            });

            // --- PÜRÜZSÜZ DİREKSİYON (TİTREŞİM ENGELLEYİCİ) ---
            // Deadzone: Eğer açı çok küçükse (0-2 derece) hareket etme
            if (Math.abs(rawSteeringAngle) < 2) rawSteeringAngle = 0;

            // Low Pass Filter (Yavaşça hedefe yaklaşma)
            smoothSteeringAngle = Phaser.Math.Linear(smoothSteeringAngle, rawSteeringAngle, lerpFactor);

            let targetX = (w / 2) + (smoothSteeringAngle * 28);
            player.x = Phaser.Math.Linear(player.x, targetX, 0.1); // Ekstra yumuşatma
            
            let limit = w * 0.25;
            player.x = Phaser.Math.Clamp(player.x, w/2 - limit, w/2 + limit);
            player.angle = smoothSteeringAngle * 0.4;

            // HUD
            hud.style.borderColor = isTracking ? "#0f0" : "#f00";
            dot.style.left = `${50 + (smoothSteeringAngle * 2.5)}%`;
            dot.style.top = `${50 + ((handHeight - 0.5) * 100)}%`;

            document.getElementById("kmh").innerText = Math.floor(currentSpeed * 8);
            document.getElementById("score").innerText = String(Math.floor(currentSpeed * 50)).padStart(6, '0');
        }

        async function initAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 2
            });
            startKamera();
        }

        function startKamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
                video.srcObject = s;
                video.addEventListener("loadeddata", predict);
            });
        }

        async function predict() {
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const result = handLandmarker.detectForVideo(video, performance.now());

                if (result.landmarks && result.landmarks.length === 2) {
                    isTracking = true;
                    const h1 = result.landmarks[0][0];
                    const h2 = result.landmarks[1][0];
                    let deg = Math.atan2(h2.y - h1.y, h2.x - h1.x) * (180 / Math.PI);
                    if (deg > 90) deg -= 180;
                    if (deg < -90) deg += 180;
                    
                    rawSteeringAngle = -deg * 1.5; // Ham veri
                    handHeight = (h1.y + h2.y) / 2;
                } else {
                    isTracking = false;
                    rawSteeringAngle = 0;
                    handHeight = 0.8;
                }
            }
            requestAnimationFrame(predict);
        }

        initAI();
    </script>
</body>
</html>