<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S23 Ultra - AI Racer</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; }
        #game-container { width: 100vw; height: 100vh; }
        #video-preview { 
            position: absolute; bottom: 10px; right: 10px; width: 160px; height: 120px; 
            border: 2px solid #00ff00; border-radius: 8px; transform: scaleX(-1); z-index: 10; opacity: 0.7;
        }
        #ui-info { position: absolute; top: 10px; left: 10px; color: #0f0; z-index: 20; background: rgba(0,0,0,0.5); padding: 5px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui-info">Açı: <span id="angleText">0</span>°</div>
    <video id="webcam" autoplay playsinline style="display:none"></video>
    <canvas id="video-preview"></canvas>
    <div id="game-container"></div>

    <script type="module">
        import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

        const video = document.getElementById("webcam");
        const previewCanvas = document.getElementById("video-preview");
        const previewCtx = previewCanvas.getContext("2d");
        const angleText = document.getElementById("angleText");

        let handLandmarker;
        let lastVideoTime = -1;
        let steeringAngle = 0;

        // --- PHASER OYUN MOTORU AYARLARI ---
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let car, roadLines;

        function preload() {
            // Araba ve yol için basit şekiller oluşturalım (Görsel yüklemekle uğraşmayalım)
        }

        function create() {
            // Yol (Asfalt)
            this.add.rectangle(config.width/2, config.height/2, config.width * 0.8, config.height, 0x333333);
            
            // Yol Çizgileri
            roadLines = this.add.group();
            for(let i=0; i<10; i++) {
                let line = this.add.rectangle(config.width/2, i * 100, 10, 50, 0xffffff);
                roadLines.add(line);
            }

            // Araba (Kırmızı bir dikdörtgen)
            car = this.add.rectangle(config.width/2, config.height - 100, 60, 100, 0xff0000);
            this.add.text(config.width/2 - 20, config.height - 110, "EZEL", {fontSize: '12px', fill: '#fff'});
        }

        function update() {
            // Yol çizgilerini aşağı kaydır (Hareket efekti)
            roadLines.getChildren().forEach(line => {
                line.y += 10; // Hız
                if (line.y > config.height) line.y = -50;
            });

            // Arabayı direksiyon açısına göre hareket ettir
            // Hassasiyeti ayarlamak için 0.5 ile çarpıyoruz
            const targetX = (config.width/2) + (steeringAngle * 8);
            car.x = Phaser.Math.Linear(car.x, targetX, 0.1); 
            car.angle = steeringAngle * 0.5; // Arabayı hafifçe yan yatır
        }

        // --- MEDIAPIPE AI AYARLARI ---
        async function initAI() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 2
            });
            startKamera();
        }

        function startKamera() {
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predict);
            });
        }

        async function predict() {
            previewCanvas.width = video.videoWidth;
            previewCanvas.height = video.videoHeight;

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const result = handLandmarker.detectForVideo(video, performance.now());

                previewCtx.clearRect(0,0, previewCanvas.width, previewCanvas.height);
                previewCtx.drawImage(video, 0, 0);

                if (result.landmarks && result.landmarks.length === 2) {
                    const h1 = result.landmarks[0][0];
                    const h2 = result.landmarks[1][0];
                    
                    let deg = Math.atan2(h2.y - h1.y, h2.x - h1.x) * (180 / Math.PI);
                    if (deg > 90) deg -= 180;
                    if (deg < -90) deg += 180;
                    
                    steeringAngle = -deg; // Küresel değişkene aktar
                    angleText.innerText = Math.round(steeringAngle);
                }
            }
            requestAnimationFrame(predict);
        }

        initAI();
    </script>
</body>
</html>